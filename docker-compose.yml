version: '3.8'

services:
  backend:
    build:
      context: ./src
      dockerfile: ${ENVIRONMENT:-local}
      dockerfile: Dockerfile.backend
    container_name: fastapi-backend-${ENVIRONMENT:-local}
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      # Mount source code for local development only
      - ${BACKEND_CODE_MOUNT:-./src}:/app
      # Database
      - ./${DATABASE_NAME:-personal_app.db}:/app/${DATABASE_NAME:-personal_app.db}
      # External drive
      - ${EXTERNAL_DRIVE_PATH}:/mnt/storage1:ro
    env_file:
      - src/.env
    environment:
      - DATABASE_URL=sqlite:///${DATABASE_NAME:-personal_app.db}
      - STORAGE_PATH=/mnt/storage1
      - ENVIRONMENT=${ENVIRONMENT:-local}
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.frontend.${ENVIRONMENT:-local}
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost/api}
        - NEXT_PUBLIC_ENVIRONMENT=${ENVIRONMENT:-local}
        - NEXT_PUBLIC_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
    container_name: nextjs-frontend-${ENVIRONMENT:-local}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    volumes:
      # Mount source code for local development only
      - ${FRONTEND_CODE_MOUNT:-./frontend/src}:/app/src
      - ${FRONTEND_PAGES_MOUNT:-./frontend/pages}:/app/pages
      - ${FRONTEND_PUBLIC_MOUNT:-./frontend/public}:/app/public
      - /app/node_modules
      - /app/.next
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost/api}
      - NEXT_PUBLIC_ENVIRONMENT=${ENVIRONMENT:-local}
      - NEXT_PUBLIC_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
    depends_on:
      - backend
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  nginx:
    image: nginx:alpine
    container_name: nginx-proxy-${ENVIRONMENT:-local}
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ${SSL_CERT_MOUNT:-./certbot/conf}:/etc/letsencrypt:ro
      - ${SSL_WEBROOT_MOUNT:-./certbot/www}:/var/www/certbot:ro
    depends_on:
      - frontend
      - backend
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  certbot:
    image: certbot/certbot
    container_name: certbot-${ENVIRONMENT:-local}
    profiles:
      - production
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"